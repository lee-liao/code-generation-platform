<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Generation Platform</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            color: #333333;
        }
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
                color: #e0e0e0;
            }
            input[type="text"], textarea {
                background-color: #333333;
                color: #e0e0e0;
                border: 1px solid #555555;
            }
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .running {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .done {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            margin-bottom: 20px;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            margin-right: 0;
            color: #333; /* Ensure text is visible in both light and dark modes */
        }
        .tab button:hover {
            background-color: #ddd;
            color: #333; /* Maintain text color on hover */
        }
        .tab button.active {
            background-color: #ccc;
            color: #333; /* Maintain text color for active tab */
        }
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }
        .tabcontent.active {
            display: block;
        }
        /* Dark mode support for tabs */
        @media (prefers-color-scheme: dark) {
            .tab {
                border: 1px solid #555;
                background-color: #333;
            }
            .tab button {
                background-color: #333;
                color: #e0e0e0;
            }
            .tab button:hover {
                background-color: #444;
                color: #e0e0e0;
            }
            .tab button.active {
                background-color: #555;
                color: #e0e0e0;
            }
            .tabcontent {
                border: 1px solid #555;
            }
        }
    </style>
</head>
<body>
    <h1>Code Generation Platform</h1>
    
    <div class="tab">
        <button class="tablinks active" onclick="openTab(event, 'CodebaseGeneration')">Codebase Generation</button>
        <button class="tablinks" onclick="openTab(event, 'OpenSpecImplementation')">OpenSpec Implementation</button>
    </div>
    
    <!-- Codebase Generation Tab -->
    <div id="CodebaseGeneration" class="tabcontent active">
        <h2>Codebase Generation</h2>
        
        <form id="generationForm">
            <div class="form-group">
                <label for="projectFolder">Project Folder With Spec:</label>
                <input type="text" id="projectFolder" name="projectFolder" required>
                <small>Path to the template project directory</small>
            </div>
            
            <div class="form-group">
                <label for="repoName">GitHub Repository Name:</label>
                <input type="text" id="repoName" name="repoName" required>
                <small>Name for the new GitHub repository</small>
            </div>
            
            <div class="form-group">
                <label for="repoDescription">GitHub Repository Description:</label>
                <input type="text" id="repoDescription" name="repoDescription">
                <small>Description for the new GitHub repository</small>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="verboseLogging" name="verboseLogging"> 
                    Enable Claude AI verbose logging (sets ANTHROPIC_LOG=debug)
                </label>
            </div>
            
            <button type="submit" id="submitBtn">Generate Codebase</button>
        </form>
        
        <div id="generationStatus"></div>
    </div>
    
    <!-- OpenSpec Implementation Tab -->
    <div id="OpenSpecImplementation" class="tabcontent">
        <h2>OpenSpec Implementation Agent</h2>
        
        <form id="openspecForm" enctype="multipart/form-data">
            <div class="form-group">
                <label for="openspecRepoName">GitHub Repository Name:</label>
                <input type="text" id="openspecRepoName" name="repoName" required>
                <small>Name of the GitHub repository to implement changes in</small>
            </div>
            
            <div class="form-group">
                <label for="openspecZipFile">OpenSpec Change Zip File:</label>
                <input type="file" id="openspecZipFile" name="zipFile" accept=".zip" required>
                <small>Upload a zip file containing OpenSpec change specifications</small>
            </div>
            
            <button type="submit" id="openspecSubmitBtn">Start OpenSpec Implementation</button>
        </form>
        
        <div id="openspecStatus"></div>
    </div>
    
    <script>
        // Tab functionality
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Codebase Generation Form
        const generationForm = document.getElementById('generationForm');
        const generationSubmitBtn = document.getElementById('submitBtn');
        const generationStatusDiv = document.getElementById('generationStatus');
        
        generationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(generationForm);
            const data = {
                projectFolder: formData.get('projectFolder'),
                repoName: formData.get('repoName'),
                repoDescription: formData.get('repoDescription'),
                verboseLogging: document.getElementById('verboseLogging').checked
            };
            
            // Disable the submit button and show running status
            generationSubmitBtn.disabled = true;
            generationStatusDiv.style.display = 'block';
            generationStatusDiv.className = 'running';
            generationStatusDiv.textContent = 'Running... at step initial validation';
            
            try {
                // Start the codebase generation task
                const response = await fetch('/generate-codebase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                const { taskId } = await response.json();
                
                // Start polling for task status
                await pollTaskStatus(taskId, generationStatusDiv, generationSubmitBtn);
            } catch (error) {
                generationStatusDiv.className = 'error';
                generationStatusDiv.textContent = `Error: ${error.message}`;
                generationSubmitBtn.disabled = false;
            }
        });
        
        // OpenSpec Implementation Form
        const openspecForm = document.getElementById('openspecForm');
        const openspecSubmitBtn = document.getElementById('openspecSubmitBtn');
        const openspecStatusDiv = document.getElementById('openspecStatus');
        
        openspecForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(openspecForm);
            
            // Validate inputs
            const repoName = formData.get('repoName');
            const zipFile = formData.get('zipFile');
            
            if (!repoName || !zipFile) {
                openspecStatusDiv.style.display = 'block';
                openspecStatusDiv.className = 'error';
                openspecStatusDiv.textContent = 'GitHub repository name and zip file are required';
                return;
            }
            
            // Disable the submit button and show running status
            openspecSubmitBtn.disabled = true;
            openspecStatusDiv.style.display = 'block';
            openspecStatusDiv.className = 'running';
            openspecStatusDiv.textContent = 'Uploading file and starting OpenSpec implementation...';
            
            try {
                // Start the OpenSpec implementation task
                const response = await fetch('/openspec/openspec-implement', {
                    method: 'POST',
                    body: formData  // Send as multipart form data
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                const { taskId } = await response.json();
                
                // Start polling for task status
                await pollTaskStatus(taskId, openspecStatusDiv, openspecSubmitBtn);
            } catch (error) {
                openspecStatusDiv.className = 'error';
                openspecStatusDiv.textContent = `Error: ${error.message}`;
                openspecSubmitBtn.disabled = false;
            }
        });
        
        // Common polling function
        async function pollTaskStatus(taskId, statusDiv, submitBtn) {
            let taskDone = false;
            
            while (!taskDone) {
                try {
                    const response = await fetch(`/openspec/task-status/${taskId}`);
                    const status = await response.json();
                    
                    if (response.ok) {
                        statusDiv.textContent = status.message || `Running... at step ${status.step || 'unknown'}`;
                        
                        // Add kill button when Claude AI is processing
                        if (status.step === 'claude-implementation' && !document.getElementById('killBtn')) {
                            const killBtn = document.createElement('button');
                            killBtn.id = 'killBtn';
                            killBtn.textContent = 'Kill Process';
                            killBtn.style.marginLeft = '10px';
                            killBtn.onclick = () => killProcess(taskId);
                            statusDiv.appendChild(document.createElement('br'));
                            statusDiv.appendChild(killBtn);
                        }
                        
                        if (status.completed) {
                            // Remove kill button if it exists
                            const killBtn = document.getElementById('killBtn');
                            if (killBtn) killBtn.remove();
                            
                            // Check if the task was successful or failed
                            if (status.message && status.message.includes('Error:')) {
                                // Task failed
                                statusDiv.className = 'error';
                                statusDiv.innerHTML = `<strong>Failed!</strong><br>${status.summary || status.message}`;
                            } else if (status.step === 'error') {
                                // Task failed with error step
                                statusDiv.className = 'error';
                                statusDiv.innerHTML = `<strong>Failed!</strong><br>${status.summary || 'Process failed.'}`;
                            } else {
                                // Task completed successfully
                                statusDiv.className = 'done';
                                statusDiv.innerHTML = `<strong>Done!</strong><br>${status.summary || 'Process completed successfully.'}`;
                            }
                            taskDone = true;
                            submitBtn.disabled = false;
                        }
                    } else {
                        // Remove kill button if it exists
                        const killBtn = document.getElementById('killBtn');
                        if (killBtn) killBtn.remove();
                        
                        throw new Error(status.error || 'Unknown error occurred');
                    }
                } catch (error) {
                    // Remove kill button if it exists
                    const killBtn = document.getElementById('killBtn');
                    if (killBtn) killBtn.remove();
                    
                    statusDiv.className = 'error';
                    statusDiv.textContent = `Error checking status: ${error.message}`;
                    submitBtn.disabled = false;
                    taskDone = true;
                }
                
                // Wait before polling again
                if (!taskDone) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }
        
        async function killProcess(taskId) {
            const killBtn = document.getElementById('killBtn');
            if (killBtn) {
                killBtn.disabled = true;
                killBtn.textContent = 'Terminating...';
            }
            
            try {
                const response = await fetch(`/kill-process/${taskId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('generationStatus').innerHTML += `<br><strong>Process terminated:</strong> ${result.message}`;
                    document.getElementById('openspecStatus').innerHTML += `<br><strong>Process terminated:</strong> ${result.message}`;
                    if (killBtn) killBtn.remove();
                } else {
                    document.getElementById('generationStatus').innerHTML += `<br><strong>Error terminating process:</strong> ${result.error}`;
                    document.getElementById('openspecStatus').innerHTML += `<br><strong>Error terminating process:</strong> ${result.error}`;
                }
            } catch (error) {
                document.getElementById('generationStatus').innerHTML += `<br><strong>Error terminating process:</strong> ${error.message}`;
                document.getElementById('openspecStatus').innerHTML += `<br><strong>Error terminating process:</strong> ${error.message}`;
            }
        }
    </script>
</body>
</html>