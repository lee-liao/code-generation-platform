require('dotenv').config();
const { GitHubApp } = require('../github-app');
const { calculateDeltas } = require('../utils/git-ops');
const path = require('path');
const fs = require('fs').promises;
const { execSync } = require('child_process');

async function runRealRepoTest() {
    const githubApp = new GitHubApp();

    // Configuration
    const owner = 'DrLinAITeam2';
    const repo = 'simplest-repo';
    const timestamp = Date.now();
    const branchName = `workflow-test-${timestamp}`;
    const tempDir = path.join(__dirname, `../temp/workflow-${timestamp}`);

    console.log(`=== Starting Real Repo Workflow Test: ${owner}/${repo} ===`);

    try {
        // 1. Create a branch from main
        console.log(`\n1. Creating branch '${branchName}' from 'main'...`);
        await githubApp.createBranch(owner, repo, branchName, 'main');
        console.log(`✓ Branch '${branchName}' created.`);

        // 2. Clone (download) the branch to a temporary directory
        console.log(`\n2. Downloading branch to '${tempDir}'...`);
        await fs.mkdir(tempDir, { recursive: true });
        await githubApp.downloadRepository(owner, repo, branchName, tempDir);
        console.log(`✓ Repository downloaded.`);

        // 3. Initialize temporary directory (Simulate git environment)
        console.log(`\n3. Initializing local Git environment...`);
        // Note: git-ops.js doesn't export 'init', so we do it manually to prepare for calculateDeltas
        execSync('git init', { cwd: tempDir });
        execSync('git config user.email "test@bot.com"', { cwd: tempDir });
        execSync('git config user.name "Test Bot"', { cwd: tempDir });
        execSync('git add .', { cwd: tempDir });
        execSync('git commit -m "Base state"', { cwd: tempDir });
        console.log(`✓ Local git repo initialized and base committed.`);

        // 4. Create a new file locally
        console.log('\n4. Making local changes...');
        const fileName = `auto-generated-${timestamp}.js`;
        const filePath = path.join(tempDir, fileName);
        const fileContent = `// Auto-generated file at ${new Date().toISOString()}\nconsole.log("Hello from automated workflow!");`;

        await fs.writeFile(filePath, fileContent);
        console.log(`✓ Created file: ${fileName}`);

        // 5. Use git utils to get changed codes
        console.log(`\n5. Using git-ops.js to detect changes...`);
        const deltas = await calculateDeltas(tempDir);
        console.log(`✓ Deltas detected:`, deltas);

        if (deltas.additions.length === 0 && deltas.modifications.length === 0) {
            throw new Error('No changes detected by calculateDeltas!');
        }

        // Prepare payload for push
        // We iterate over the detected changes to read their current content
        const filesToPush = [];

        // Additions & Modifications
        for (const file of [...deltas.additions, ...deltas.modifications]) {
            const content = await fs.readFile(path.join(tempDir, file));
            filesToPush.push({
                path: file,
                content: content.toString('base64'),
                encoding: 'base64'
            });
        }

        // Deletions
        for (const file of deltas.deletions) {
            filesToPush.push({
                path: file,
                content: null
            });
        }

        // 6. Push code changes to the remote branch
        console.log(`\n6. Pushing changes to remote branch '${branchName}'...`);
        await githubApp.pushChanges(owner, repo, `Add ${fileName} via automation`, filesToPush, branchName, branchName);
        console.log(`✓ Changes pushed.`);

        // 7. Create a Pull Request to merge the changes into main
        console.log(`\n7. Creating Pull Request...`);
        const pr = await githubApp.createPullRequest(
            owner,
            repo,
            `Workflow Test ${timestamp}`,
            `Generated by automate workflow test.\nFile: ${fileName}`,
            branchName,
            'main'
        );
        console.log(`✓ Pull Request Created!`);
        console.log(`  URL: ${pr.html_url}`);

    } catch (error) {
        console.error('\n❌ Test Failed:', error);
    }
}

runRealRepoTest();
